// Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.

let markerTmp; 

let callDeux = function() {
  $.ajax({url: '/put_address', type: 'POST', data: 'address=' + $("#address")[0].value + '&long=' + markerTmp._latlng.lng + '&lati=' + markerTmp._latlng.lat + '&nom=' + $("#name")[0].value + '&description=' + $("#description")[0].value, dataType: 'JSON', complete: (function(data) {
    let locali = data.responseJSON.put;
    let newAdd = new L.latLng(locali.latitude, locali.longitude);
    let myIcon = new L.icon({ iconUrl: "<%= asset_path("douge.png") %>", iconSize: [45, 50]});
    let marker = new L.Marker(newAdd, {icon: myIcon, autoPan: true});
    marker.addTo(mymap);
    markerTmp.remove();
$(a).remove();
    $("#add").show();
  })});
}

let callUn = function() {
  $.ajax({url: "/find_address", type: 'POST', data: 'address=' + $("#address")[0].value, dataType: 'JSON', complete: (function(data) {
    let local = data.responseJSON.rendu;
    let place = new L.latLng(local.latitude, local.longitude );
    let temp = new L.icon({ iconUrl: "<%= asset_path("jul.jpg") %>", iconSize: [45, 50]});
    markerTmp = new L.Marker(place, {icon: temp, autoPan: true, draggable: true});
    markerTmp.addTo(mymap);
    mymap.setView([local.latitude, local.longitude]);
    toggleModal();
    $("#add").hide();

    a = document.createElement("div");
    $(a).addClass("add_delete_div");
    b = document.createElement("button");
    $(b).addClass("validate-position");
    $(a).prepend($(b));
    $(a).html("ok");
    $(b).prependTo($('body'));
    $(a).css({display: "block", zIndex: "10000"});
    $(b).css({display: "block", zIndex: "10000"});


    $(a).click(function() { 
      callDeux(); 
    });
  })
  });
}


$(".EN ATTENTE").click(function() {
  center = mymap.getCenter();
  $.ajax({url: "/add_place", type: 'POST', data: 'lati=' + center.lat + "&long=" + center.lng, dataType: 'JSON', body: 'rendu', complete: (function(data) {
    let local = data.responseJSON.rendu
    let place = new L.latLng(local.latitude, local.longitude );
    let myIcon = new L.icon({ iconUrl: "<%= asset_path("douge.png") %>", iconSize: [45, 50]});
    let marker = new L.Marker(place, {icon: myIcon, autoPan: true});
    marker.addTo(mymap);
  })
  });});


$("#add").click(function () {
  if($("#address")[0].value === "" ) {
    alert("champs address vide");
    return (0);
  }
  callUn();
});
