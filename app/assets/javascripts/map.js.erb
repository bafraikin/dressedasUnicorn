let userLoc = new Array;
let localisable = new Boolean;

let masuperfonction =  function() {
  bound = mymap.getBounds();
  $.ajax({url: "/", type: 'POST', data: 'Nlat=' + bound.getNorth() + "&Nlong=" + bound.getWest() + "&Slat=" + bound.getSouth() + "&Slong=" + bound.getEast() + '&test1=' + mymap.getCenter().lat + '&test2=' + mymap.getCenter().lng  , dataType: 'JSON', body: 'rendu', complete: ( 
    function(data) {
      for (let local of data.responseJSON.rendu) {
        if (timestamp.includes(local["created_at"]) != true ) {
          timestamp.push(local["created_at"]);
          let place = new L.latLng(local.latitude, local.longitude);
          let myIcon = new L.icon({ iconUrl: "<%= asset_path("douge.png") %>" , iconSize: [45, 50] });
          let marker = new L.Marker(place, {icon: myIcon, autoPan: true});
          marker.addTo(mymap);
        }}})});};

let getLocation = function (position)
{
  userLoc.push(parseFloat(position.coords.latitude));
  userLoc.push(parseFloat(position.coords.latitude));
  localisable = true;
}
let errorLoc = function (position) {
  userLoc.push(48.866667);
  userLoc.push(2.333333);
  localisable = false;
}

/* ----------------------------------------------------------------- */
// Cree la map
let pos = new Array;

navigator.geolocation.getCurrentPosition(getLocation, errorLoc);
let mymap = L.map('mapid').setView([userLoc[0],userLoc[1]], 14);
let timestamp = new Array; 
let layer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
  attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
  maxZoom: 18,
  transparent: true,
  id: 'mapbox.streets',
  accessToken: 'pk.eyJ1IjoiYmZyYWlraW4iLCJhIjoiY2podWxwc21pMG5udjNqdDZpZGluaGhxeSJ9.WaMLYylJhk6ULiaGSWNuAA',
}).addTo(mymap);
debugger;
/* -------------------------------------------------------------------   */

// musée du 1er call ajax
mymap.on('zoomend', masuperfonction);
// quand la map arrête de bouger
mymap.on('moveend', masuperfonction);

